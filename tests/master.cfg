#!/usr/bin/env python3


from buildbot.plugins import (
    worker, changes, util, steps, schedulers, util
)


repo_base_url = 'github.com/multun/dish'

def gitize(url):
    s = url.split('/')
    return s[0] + ':' + '/'.join(s[1:])

repo_git_url = gitize(repo_base_url)

factory = util.GNUAutoconf(source=steps.Git(repourl=repo_git_url,
                                               mode='incremental'),
                              reconf=['./bootstrap'])

authz = util.Authz(
  allowRules=[
    util.AnyControlEndpointMatcher(role="admins"),
  ],
  roleMatchers=[
    util.RolesFromEmails(admins=["victor.collod@epita.fr"])
  ]
)

auth = util.UserPasswordAuth({'victor.collod@epita.fr': 'nopasswordforyou:)'})

BuildmasterConfig = {
    'workers': [worker.LocalWorker("local_alpha")],
    'protocols': {'pb': {'port': 9989}},
    'change_source': [
        changes.GitPoller(
            repo_git_url,
            workdir='gitpoller-workdir', branch='master',
            pollinterval=60)
    ],
    'schedulers': [
        schedulers.SingleBranchScheduler(
            name="all",
            change_filter=util.ChangeFilter(branch_re='.*'),
            treeStableTimer=None,
            builderNames=["local_builder"]),
        schedulers.ForceScheduler(
            name="force",
            builderNames=["local_builder"]),
    ],
    'builders': [
        util.BuilderConfig(name="local_builder",
                           workernames=["local_alpha"],
                           factory=factory),
    ],
    'services': [],
    'title': "dish",
    'titleURL': f"https://{repo_base_url}/",

    # html reported url
    'buildbotURL': "http://boulet.tobast.fr:8010/",

    # webserver url
    'www': {
        'port': 8010,
        'plugins': dict(waterfall_view={},
                        console_view={},
                        grid_view={}),
        'auth': auth,
        'authz': authz,
    },
    'db': {
        'db_url': "sqlite:///state.sqlite",
    }
}
